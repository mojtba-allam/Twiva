---
description: 
globs: 
alwaysApply: false
---

# Laravel API Controller Rules (Modular Structure - using nwidart/laravel-modules)

## 1. General Principles

* Follow RESTful practices.
* Use Laravel Modules for separation of domains/features.
* Keep controllers thin: coordinate only, no business logic.
* Centralize error handling via `app/Exceptions/Handler.php`.
* Use consistent JSON response structure (success, errors, pagination).
* Use route model binding where possible.

---

## 2. Controller Structure

**Location:** `Modules/<ModuleName>/Http/Controllers/Api/`

**Guidelines:**

* Accept only Form Request classes for validated input.
* Return data via API Resources or standardized JSON helper.
* Authorize actions using Policies (`authorizeResource` or `authorize`).
* Use route model binding for cleaner signatures and built‑in 404s.
* Delegate heavy logic to Services.

---

## 3. Form Requests

**Location:** `Modules/<ModuleName>/Http/Requests/`

**Naming:** `Store<Entity>Request.php`, `Update<Entity>Request.php`

**Responsibilities:**

* Define `rules()` for validation.
* Optionally implement `authorize()` for per‑endpoint checks.

---

## 4. API Resources

**Location:** `Modules/<ModuleName>/Transformers/` or `Resources/`

**Naming:** `EntityResource.php`, `EntityCollection.php` (optional)

**Usage:**

```php
return response()->json([
    'message' => __('messages.entity_fetched'),
    'data'    => new EntityResource($entity)
]);
```

---

## 5. Policies

**Location:** `Modules/<ModuleName>/Policies/`

**Registration:** in `Modules/<ModuleName>/Providers/AuthServiceProvider.php`

**Usage:**

```php
$this->authorize('view', $entity);
```

---

## 6. Localization

**Location:** `Modules/<ModuleName>/Resources/lang/<locale>/messages.php`

**Key Convention:** `entity_created`, `entity_updated`, `errors.forbidden`, etc.

**Usage:**

```php
__('messages.entity_created');
```

---

## 7. JSON Responses & Helpers

* **Success:**

  ```php
  return response()->json([
      'message' => __('messages.success'),
      'data'    => $resource
  ], 200);
  ```
* **Error:**

  ```php
  return response()->json([
      'message' => __('messages.unauthorized')
  ], 403);
  ```
* **Pagination:**

  ```php
  $paginator = $query->paginate();
  return response()->json([
      'message' => __('messages.entities_listed'),
      'data'    => EntityResource::collection($paginator),
      'meta'    => [
          'current_page' => $paginator->currentPage(),
          'last_page'    => $paginator->lastPage(),
          'per_page'     => $paginator->perPage(),
          'total'        => $paginator->total(),
      ],
  ]);
  ```

---

## 8. Centralized Exception Handling

**File:** `app/Exceptions/Handler.php`

**Handle:**

* `ModelNotFoundException` → 404 JSON
* `AuthorizationException` → 403 JSON
* `ValidationException` → 422 JSON

**Example:**

```php
public function render($request, Throwable $e)
{
    if ($e instanceof ModelNotFoundException) {
        return response()->json(['message' => __('messages.not_found')], 404);
    }
    if ($e instanceof AuthorizationException) {
        return response()->json(['message' => __('messages.forbidden')], 403);
    }
    return parent::render($request, $e);
}
```

---

## 9. Service Layer (Optional)

**Location:** `Modules/<ModuleName>/Services/`

**Pattern:**

```php
$created = $this->service->create($request->validated());
```

**Purpose:**

* Encapsulate business rules, transactions, notifications.

---

## 10. Route Model Binding

**Controller Signature:**

```php
public function show(Entity $entity)
```

**Benefit:** Cleaner code, implicit 404.

---

## 11. API Versioning

* Prefix routes: `/api/v1/...` in module routes files.
* Maintain `routes/api.php` per module or central grouping.
* Document deprecation strategy for v1 → v2.

---

## 12. Logging & Monitoring

* Inject `Log` or use `Log::channel('api')->info(...)` in key actions.
* Integrate error tracking (Sentry, Bugsnag).
* Log user ID, request payload (scrub sensitive fields).

---

## 13. Rate Limiting / Throttling

* Apply middleware: `->middleware(['auth:api','throttle:60,1'])`
* Define named limiters in `App\Providers\RouteServiceProvider`.

---

## 14. Caching Strategies

* Cache heavy lists or filters:

  ```php
  $items = Cache::remember('items_list', 60, fn() => Model::all());
  ```
* Invalidate on create/update/delete.

---

## 15. API Documentation

* Use Swagger/OpenAPI annotations (e.g. in docblocks).
* Generate docs via `DarkaOnLine/L5-Swagger` or similar.

---

## 16. Testing Conventions

**Location:** `Modules/<ModuleName>/Tests/Feature/`

**Naming:** `<Entity>ControllerTest.php`

**Include:**

* Happy path (200, 201).
* Unauthorized (401, 403).
* Not found (404).
* Validation errors (422).

---

## 17. Security Headers

* Ensure JSON only: `->header('Content-Type','application/json')`
* CORS: configure `cors.php` and middleware.
* Custom headers: `X-RateLimit-*`, `X-Request-ID`.

---

## 18. API Routes Rules

**Location:** `Modules/<ModuleName>/Routes/api.php`

**Guidelines:**

* Prefix group with version and module:

  ```php
  Route::group([
      'prefix' => 'api/v1/orders',
      'middleware' => ['api','auth:api','throttle:60,1'],
      'as' => 'orders.'
  ], fn() => {
      Route::get('/', [OrderController::class,'index'])->name('index');
      Route::post('/', [OrderController::class,'store'])->name('store');
      Route::get('{order}', [OrderController::class,'show'])->name('show');
      Route::put('{order}', [OrderController::class,'update'])->name('update');
      Route::delete('{order}', [OrderController::class,'destroy'])->name('destroy');
  });
  ```
* Always use controller methods (no closures).
* Name routes using module.action (e.g. `orders.store`).
* Use route caching (`php artisan route:cache`).

---

## 19. Search Optimization

To make search queries fast and efficient:

* **Database Indexing:**

  * Add indexes on columns used in `WHERE`, `ORDER BY`, and `JOIN` clauses (e.g., `name`, `email`, `created_at`).
  * Use composite indexes when filtering on multiple columns together.

* **Full-Text Search Engines:**

  * Use Laravel Scout with drivers like Algolia or MeiliSearch for large datasets and relevance ranking.
  * Configure Scout to sync models and define searchable fields in `toSearchableArray()`.

* **Query Optimization:**

  * Avoid `SELECT *`; select only necessary columns using `->select('id', 'name', ...)`.
  * Use `where()` filters before `with()` to minimize loaded data.
  * Leverage `chunk()` or cursor pagination (`->cursorPaginate()`) for very large resultsets.

* **Eager Loading & Pagination:**

  * Use `->with()` to eager-load relationships and prevent N+1 queries.
  * Paginate results to limit the number of records returned per request.

* **Caching Search Results:**

  * Cache frequent searches with `Cache::remember()` and invalidate on data changes.
  * Use short TTL (e.g., 60 seconds) for near-real-time freshness.

* **Rate Limiting & Throttling:**

  * Apply rate limits to search endpoints to prevent abuse and reduce load.

* **Asynchronous Processing (Advanced):**

  * For complex search aggregations, consider background jobs to pre-compute indexes or summaries.

---

## ✅ Folder Structure Template

```
Modules/
└── Orders/
    ├── Http/
    │   ├── Controllers/Api/OrderController.php
    │   └── Requests/
    │       ├── StoreOrderRequest.php
    │       └── UpdateOrderRequest.php
    ├── Policies/OrderPolicy.php
    ├── Providers/AuthServiceProvider.php
    ├── Resources/lang/en/messages.php
    ├── Transformers/OrderResource.php
    ├── Services/OrderService.php
    └── Routes/api.php
```

---
